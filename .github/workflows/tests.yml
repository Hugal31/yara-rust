name: tests

on:
  push:
    paths-ignore:
      - 'LICENSE-*'
      - '**.md'
  pull_request:
    paths-ignore:
      - 'LICENSE-*'
      - '**.md'

jobs:
  linters:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true
      - name: Install rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
      - name: Install rustfmt and clippy
        run: rustup component add rustfmt clippy
      - name: Cargo fmt
        uses: actions-rs/cargo@v1
        with:
          command: fmt
          args: --all -- --check
      - name: Cargo clippy
        uses: actions-rs/cargo@v1
        with:
          command: clippy
          args: --features bindgen,bundled-4_3_0,vendored -- -D warnings

  test-posix:
    strategy:
      matrix:
        os: [ ubuntu-latest ]
        target: ["x86_64-unknown-linux-musl", "x86_64-unknown-linux-gnu"]
        features: [ "vendored,bindgen", "vendored,bundled-4_3_0" ]
        rust: [ stable, nightly ]

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true
      - name: Install rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ matrix.rust }}
          target: ${{ matrix.target }}
          override: true
      # Skip tests containing "proc", they seem to fail randomly on the pipeline.
      - name: Test
        uses: actions-rs/cargo@v1
        with:
          command: test
          toolchain: ${{ matrix.rust }}
          args: --verbose --no-default-features --features ${{ matrix.features }},module-hash,module-dotnet,module-dex,module-macho,ndebug -- --skip proc

  test-windows:
    strategy:
      matrix:
        os: [ windows-2019 ]
        features: [ "vendored,bundled-4_3_0" ]
        rust: [ stable ]
        cryptolib: [ "OpenSSL", "WinCrypt", "disabled" ]

    runs-on: ${{ matrix.os }}
    steps:
        - name: Install OpenSSL
          if: ${{ matrix.cryptolib == 'OpenSSL' }}
          run: choco install openssl
        - uses: actions/checkout@v2
          with:
            submodules: true
        - name: Install rust toolchain
          uses: actions-rs/toolchain@v1
          with:
            toolchain: ${{ matrix.rust }}
            override: true
        - name: Test
          uses: actions-rs/cargo@v1
          env:
            YARA_CRYPTO_LIB: ${{ matrix.cryptolib }}
            INCLUDE: C:\Program Files\OpenSSL-Win64\include
            LIBRARY: C:\Program Files\OpenSSL-Win64\lib
            LIB: C:\Program Files\OpenSSL-Win64\lib
          # Skip tests containing "proc", they seem to fail randomly on the pipeline.
          with:
            command: test
            toolchain: ${{ matrix.rust }}
            args: --verbose --no-default-features --features ${{ matrix.features }},module-hash,module-dotnet,module-dex,module-macho,ndebug -- --skip proc


  build-macos:
    strategy:
      matrix:
        os: [ macos-10.15 ]
        features: [ "vendored,bindgen", "vendored,bundled-4_3_0" ]
        rust: [ stable, nightly ]
        cryptolib: [ "OpenSSL", "CommonCrypto", "disabled" ]
        openssl_dir: [ "/usr/local/opt/openssl@1.1" ]

    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true
      - name: Install rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: ${{ matrix.rust }}
          override: true
      - name: Test
        uses: actions-rs/cargo@v1
        env:
          YARA_CRYPTO_LIB: '${{ matrix.cryptolib }}'
          CFLAGS: '-I ${{ matrix.openssl_dir }}/include'
          OPENSSL_LIB_DIR: '${{ matrix.openssl_dir }}/lib'
        with:
          command: build
          toolchain: ${{ matrix.rust }}
          args: --verbose --no-default-features --features ${{ matrix.features }},module-hash,module-dotnet,module-dex,module-macho,ndebug
